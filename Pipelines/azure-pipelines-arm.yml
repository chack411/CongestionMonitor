# ARM Deployment for Congestion Monitor resources

trigger:
  branches:
   include:
     - master
  paths:
    include:
      - ARMTemplates/template.json
      - ARMTemplates/parameters.json
      - Pipelines/azure-pipelines-arm.yml

pr:
  branches:
   include:
     - master
  paths:
    include:
      - ARMTemplates/template.json
      - ARMTemplates/parameters.json
      - Pipelines/azure-pipelines-arm.yml

variables:
  # Resouce Group Name
  rgName: 'cm-armdeploytest1'
  locName: 'Japan East'

  # Working Directory
  workingDirectory: '$(System.DefaultWorkingDirectory)/ARMTemplates'

steps:
- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'ARM Deployment'
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: 'Edtter (bd5c9737-10a5-4178-9b83-fd223f7b4bb4)'
    subscriptionId: 'bd5c9737-10a5-4178-9b83-fd223f7b4bb4'
    action: 'Create Or Update Resource Group'
    resourceGroupName: $(rgName)
    location: $(locName)
    templateLocation: 'Linked artifact'
    csmFile: '$(workingDirectory)/template.json'
    csmParametersFile: '$(workingDirectory)/parameters.json'
    overrideParameters: -sites_cm_functionsapp_name cm-functionsapp-test1 -SignalR_cm_hub_name cm-hub-test1 -accounts_cm_faceapi_name cm-faceapi-test1 -databaseAccounts_cm_facesdb_name cm-facesdb-test1 -storageAccounts_cmfuncstorageaccount_name cmfuncstorageaccounttst1 -serverfarms_cm_functionsapp_asp_name cm-functionsapp-asp-test1
    deploymentMode: 'Incremental'
    deploymentName: 'cm-arm-deployment'
    deploymentOutputs: 'cm-arm-deployment-outputs'
- task: PowerShell@2
  displayName: 'get deployent outputs'
  inputs:
    pwsh: true
    targetType: 'inline'
    script: |
      Write-Host '$(cm-arm-deployment-outputs)'
      # $var=ConvertFrom-Json '$(cm-arm-deployment-outputs)'
      # Write-Host $var
      # $value=$var.storageAccountName.value
      # Write-Host "##vso[task.setvariable variable=storageAccount;]$value"
